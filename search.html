<!DOCTYPE html>
<html>
<head>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130197414-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-130197414-1');
	</script>

	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <link rel="icon" type="image/png" href="./images/plane_02.png"/>

    <link rel="stylesheet" href="css/styles.css" type="text/css" />

	<script src="http://code.jquery.com/jquery-3.3.1.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="scripts/scripts.js"></script>
	

    <title>Flight Scanner</title>

	<script>

        if (!sessionStorage.getItem('token')) {
			sessionStorage.clear();
            window.location.href='index.html';
		}

		$(function() {

			if (sessionStorage.getItem('version')) {
				$('#navbar-brand').html('Flight scanner ' +  sessionStorage.getItem('version'));
			}
			else {
				sessionStorage.clear();
				window.location.href='index.html';
			}
			M_F();
			VT();
			$('#SignOut').click(function() {
				sessionStorage.clear();
				window.location.href='index.html';
			});		

			var dateFormat = "dd/mm/yy",
				departure_date = $("#departure_date")
					.datepicker({
						dateFormat: "dd/mm/yy",
						showAnim: "blind",
						showButtonPanel: true,
						minDate: 0
					})
					.on( "change", function() {
						return_date.datepicker( "option", "minDate", getDate( this ) );
						$('#ddate').val( $.datepicker.formatDate( 'yy-mm-dd', new Date( getDate( this ) ) ) );
					}),
				return_date = $("#return_date")
					.datepicker({
						dateFormat: "dd/mm/yy",
						showAnim: "blind",
						showButtonPanel: true,
						minDate: 0,
						closeText: 'Clear',
						onClose: function () {
							var event = arguments.callee.caller.caller.arguments[0];                
							if ($(event.delegateTarget).hasClass('ui-datepicker-close')) {
								$(this).val('');
							}
						}
					})
					.on( {  change: function() {
								departure_date.datepicker( "option", "maxDate", getDate( this ) );
								$('#rdate').val( $.datepicker.formatDate( 'yy-mm-dd', new Date( getDate( this ) ) ) );
							},
							close: function () {
								var event = arguments.callee.caller.caller.arguments[0];                
								if ($(event.delegateTarget).hasClass('ui-datepicker-close')) {
									$(this).val('');
								}
							}
					} );
			
			
			function getDate( element ) {
			  var date;
			  try {
				date = $.datepicker.parseDate( dateFormat, element.value );
			  } catch( error ) {
				date = null;
			  }
		 
			  return date;
			}
			
			$( "#dialog" ).dialog({ autoOpen: false });
			$( "#opener" ).click(function() {
				$( "#dialog" ).dialog( "open" );
			});
			
			function log( message ) {
				$( "<div>" ).text( message ).prependTo( "#log" );
				$( "#log" ).scrollTop( 0 );
			}
			
			$( "#origin_descr" ).autocomplete({
				source: function( request, response ) {
					$.ajax({
						url: "https://api.sandbox.amadeus.com/v1.2/airports/autocomplete",
						dataType: "json",
						data: {
							apikey: sessionStorage.getItem('apikey'),
							term: request.term
						},
						success: function( data ) {
							response( data );
							if (data) {
							 	$("#origin_descr").val(data[0].label);
							 	$("#origin").val(data[0].value);
							 }
						}
					});
				},
				minLength: 3,
				select: function(event, ui) {
					event.preventDefault();
					$("#origin_descr").val(ui.item.label);
					$("#origin").val(ui.item.value);
				},
				focus: function(event, ui) {
					event.preventDefault();
					$("#origin_descr").val(ui.item.label);
					$("#origin").val(ui.item.value);
				},
				open: function() {
					$( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
				},
				close: function() {
					$( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
				}
			});
			
			$( "#destination_descr" ).autocomplete({
				source: function( request, response ) {
					$.ajax({
						url: "https://api.sandbox.amadeus.com/v1.2/airports/autocomplete",
						dataType: "json",
						data: {
							apikey: sessionStorage.getItem('apikey'),
							term: request.term
						},
						success: function( data ) {
							response( data );
							if (data) {
							 	$("#destination_descr").val(data[0].label);
							 	$("#destination").val(data[0].value);
							 }
						}
					});
				},
				minLength: 3,
				select: function(event, ui) {
					event.preventDefault();
					$("#destination_descr").val(ui.item.label);
					$("#destination").val(ui.item.value);
				},
				focus: function(event, ui) {
					event.preventDefault();
					$("#destination_descr").val(ui.item.label);
					$("#destination").val(ui.item.value);
				},
				open: function() {
					$( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
				},
				close: function() {
					$( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
				}
			});			
		
		
			$( "#error-dialog" ).dialog({
				autoOpen: false,
				modal: true,
				buttons: {
					Ok: function() {
						$( this ).dialog( "close" );
					}
				}
			});
		
		
			$( "form" ).submit(function( event ) {
				var flist = "";
				
				if ( $( "#origin" ).val() === "" ) { flist += "<li>Departure from</li>"; }
				if ( $( "#destination" ).val() === "" ) { flist += "<li>Arrival to</li>"; }
				if ( $( "#ddate" ).val() === "" ) { flist += "<li>Departure date</li>"; }

				var direction = $('input[name=direction]:checked').val();
				if ( direction === "2" ) { 
					if ( $( "#rdate" ).val() === "" ) { 
						flist += "<li>Arrival date</li>"; 
					}
				}
				
				if (flist === "") {

					var Mdata = "apikey=" + sessionStorage.getItem('apikey');
					Mdata += "&number_of_results=250";
					Mdata += "&currency=EUR";
					Mdata += "&origin=" + $("#origin").val();
					Mdata += "&destination=" + $("#destination").val();
					Mdata += "&departure_date=" + $("#ddate").val();
					if (direction === "2") {
						Mdata += "&return_date=" + $("#rdate").val();
					}

					$( "#searching" ).show();
					$( "#apidiv" ).html( "Retrieving data..." );
					/*********************************************/

					$.ajax({
						url: "https://api.sandbox.amadeus.com/v1.2/flights/low-fare-search",
						dataType: "json",
                        data: Mdata,
						success: function(response) {

							$("#apidiv").html(FillTheTable(response));

						} 
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        alert(textStatus+": "+errorThrown+"\n\n"+to_s(jqXHR.responseText));
                        $(e.target).prop('disabled', false);
                    });
					
					/*********************************************/
					
					$( "#searching" ).hide();
					
					event.preventDefault();
					
					return;
				} else {
					$( "#error-dialog" ).html( "<p><span class='ui-icon ui-icon-alert' style='float:left; margin:0 7px 50px 0;'></span>Please, fill all the required fields:</p><p><ul>" + flist + "</ul></p>" );
					$( "#error-dialog" ).dialog( "open" );

					event.preventDefault();
				}
			});
			
			$( "#searching" ).hide();
		
		});

        function M_F() {
            if ($(window).width() <= 800 || $(window).height() <= 600) {
                $('#c-footer').removeClass('fixed-bottom');
            }
            else {
                $('#c-footer').addClass('fixed-bottom')
            }
        }

        function VT() {
            if (sessionStorage.getItem('token')) {
                $('#SignUp').hide();
                $('#SignIn').hide();
                $('#SignOut').show();
            } else {
                $('#SignUp').show();
                $('#SignIn').show();
                $('#SignOut').hide();
            }
        }

        $( window ).resize(function() {
            M_F();
        });		

		function showRequest() {
			var x = document.getElementById("apirequest");
			var b = document.getElementById("brequest");
			
			if (x.style.display === "none") {
				x.style.display = "block";
				b.innerHTML = "Hide Request";
			} else {
				x.style.display = "none";
				b.innerHTML = "Show Request";
			}
		}
	
		function waydirection(choice) {
			var returnDate = document.getElementById("return_date");
			
			if (choice === 1) {
				returnDate.type = "hidden";
				returnDate.value = "";
			} else {
				returnDate.type = "text";
			}
		}
		
	</script>

</head>

<body>

	<nav class="navbar navbar-expand-sm navbar-dark bg-dark">
		<a id="navbar-brand" class="navbar-brand d-none d-sm-block" href="#">Flight scanner    </a>
		<ul class="navbar-nav mr-auto">
			<li class="nav-item">
				<a class="nav-link" href="index.html">Home</a>
			</li>
			<li class="nav-item">
				<a class="nav-link active">Flight search</a>
			</li>
		</ul>
		<ul class="navbar-nav ml-auto">
			<li id="SignUp" class="nav-item">
				<a class="nav-link" href="SignUp.html">Sign Up</a>
			</li>
			<li id="SignIn" class="nav-item">
				<a class="nav-link glyphicon glyphicon-envelope" href="Login.html">Sign In</a>
			</li>
			<li id="SignOut" class="nav-item">
				<a class="nav-link">Sign out</a>
			</li>
		</ul>
	</nav>

	<!-- <div class="float-right"><button class="btn btn-secondary btn-sm" type="button" id='brequest' onclick="showRequest()">Show Request</button></div> -->

	<br>
	
	<form method="post" action="">
		<div class="container">
			<div class="row justify-content-center p-2">
				<div class="col-10 col-sm-10 col-md-9 col-lg-8 col-xl-7 pb-2 border rounded p-2">
					<div class="row">
						<div class="col">
							<label >One way
								<input type="radio" id="direction" name="direction" value=1 checked="checked" onclick="waydirection(1)" > 
							</label>
							<label >Round trip
								<input type="radio" id="direction" name="direction" value=2 onclick="waydirection(2)" >
								&nbsp;&nbsp;&nbsp;&nbsp;
							</label>
							<label>Non stop only
								<input type="checkbox" id="Nonstop" >
							</label>
						</div>
					</div>
					<div class="row">
						<div class="col-8">
							<input type="text" id="origin_descr" name="origin_descr" placeholder="Departure from..." class="form-control" value=""/>
						</div>
						<div class="col-4">
							<input type="text" id="departure_date"  name="departure_date" placeholder="Departure" autocomplete="off"  class="form-date form-control" value=""/>
						</div>
					</div>
					<div class="row">
						<div class="col-8">
							<input type="text" id="destination_descr"  name="destination_descr" placeholder="Arrival to..." class="form-control" value=""/>
						</div>
						<div class="col-4">
							<input type="hidden" id="return_date" name="return_date" placeholder="Arrival" autocomplete="off"  class="form-control form-date" value=""/>
						</div>
					</div>
				</div>
				<div class="col-2 col-sm-2 col-md-2 col-lg-1 col-xl-1 p-1 border border-primary rounded">
					<input type="submit" value="Search" name="submit" class="btn  btn-primary btn-block" style="height:100%; width:100%" id="searchButton" />
					<!-- <input type="submit" value="Search" name="submit" class="btn btn-primary center" id="searchButton" /> -->
				</div>
			</div>

			<input type="hidden" id="ddate"  name="ddate" size=6 placeholder="Departure" autocomplete="off"  class="form-date form-control"> 
			<input type="hidden" id="rdate"  name="rdate" size=6 placeholder="Arrival" autocomplete="off"  class="form-date form-control"> 
				
			<input type="hidden" id="origin" name="origin" value=""/>
			<input type="hidden" id="destination" name="destination" value=""/>
		</div>
	</form>

	<div id="error-dialog" title="Filter check"></div>
	<div id="result-dialog" title="Search results"></div>
	<div id="searching" class="center-div"></div>

	<div id="apidiv" class="container-fluid"></div>
	
	</div>

	<br>
	<br>

    <footer>
		<nav id="c-footer" class="navbar fixed-bottom navbar-expand-md navbar-dark bg-dark">
		<span class="navbar-text ">Low fare flights search engine &middot; MSc in Web Intelligence &copy; 2018-2019</span>
		</nav>
	</footer>

</body>
</html>
